<!DOCTYPE html>
<html>
<head>
	<title>test</title>
	<meta charset="utf-8">
	<style>
		body {
			background-color: #eee;
		}
		body, ul {
			margin: 0; padding: 0;
		}
		i {
			font-style: normal;
		}
		#box {
			width: 900px;
			height: 500px;
			list-style: none;
			margin: 20px auto;
			/*overflow: hidden;*/
			position: relative;
			/*background: #efe;*/
		}
		#box li {
			width: 33.333%;
			float: left;
			transition-duration: .3s;
		}

		.ctn {
			/*height: 150px;*/
			margin: 5px;
			border-radius: 5px;
			box-shadow: 0 0 5px #aaa;
			background-color: #fff;
		}

		.ctn .head {
			/*margin: 0 5px;*/
			height: 30px;
			border-bottom: 1px solid #eee;
		}

		.ctn .head i {
			float: left;
			width: 30px;
			height: 30px;
			line-height: 30px;
			color: #ccc;
			text-align: center;
			cursor: pointer;
		}

		.ctn .body {

			height: 120px;
			line-height: 120px;
			text-align: center;
			font-size: 25px;
			color: #aaa;
		}

	</style>
</head>
<body onselectstart="return false">
	<ul id="box">
		<!-- <li data-mid="1">
			<div class="ctn">
				<div class="head">
					<i>☰</i>
				</div>
				<div class="body">
					1
				</div>
			</div>
		</li> -->
	</ul>


	<script>
		(function(window) {
			function bind(obj, type, fn) {
				if(obj.attachEvent) {
					obj.attachEvent('on' + type, function() {
						var ev = window.event;
						ev.target = ev.srcElement;
						fn.call(obj, ev);
					});
				} else {
					obj.addEventListener(type, fn, false);
				}
			}

			function unbind(obj, type, fn) {
				if(obj.detachEvent) {
					obj.detachEvent('on' + type, fn);
				} else {
					obj.removeEventListener(type, fn);
				}
			}

			function getPos(obj) {
				var pos = { left: obj.offsetLeft, top: obj.offsetTop };
				while(obj = obj.offsetParent)
					pos.left += obj.offsetLeft, pos.top += obj.offsetTop;
				return pos;
			}

			function layoutConvert(arg) {
				var i = arg.length, tmp, x, y
				while(--i >= 0) {
					tmp = arg[i];
					x = tmp.offsetLeft;
					y = tmp.offsetTop;
					tmp.style.left = x + 'px';
					tmp.style.top = y + 'px';
					tmp.style.position = 'absolute';
					tmp.x = x;
					tmp.y = y;
					tmp.index = i;
				}
			}

			function getStyle(e, style) {
				return window.getComputedStyle(e)[style];
			}

			var slice = [].slice;

			function Designer(box) {
				this.box = box;
				this._init();
			}

			Designer.prototype = {
				constructor: Designer,

				_init: function() {
					this.mods = slice.call(this.box.children);
					layoutConvert(this.mods);
					this.mods.forEach(function(e) {
						e.mid = e.dataset.mid;
					})
					this.z = 1;
					
					this._bindEvent();
				},

				_bindEvent: function() {
					var self = this;
					bind(this.box, 'mousedown', function(ev) {
						var e = ev.target;
						var mod, lix, liy, mx, my, duration

						var pos, dx, dy;

						if(e.nodeName === 'I' && e.parentNode.className === 'head') {
							self.mod = mod = self._getMod(e);
							if(!mod) throw new Error('无法查找到mod')
							mod.style.zIndex = ++self.z;

							duration = getStyle(mod, 'transitionDuration');
							mod.style.transitionDuration = '0s';
							mod.style.opacity = .7;

							pos = getPos(mod);
							dx = ev.clientX - pos.left;
							dy = ev.clientY - pos.top;

							modx = mod.offsetLeft, mody = mod.offsetTop;
							mx = ev.clientX, my = ev.clientY;
							bind(document, 'mousemove', e.f1 = function(ev) {
								var x = modx + ev.clientX - mx;
								var y = mody + ev.clientY - my;
								mod.style.left = x + 'px';
								mod.style.top = y + 'px';


								self._check(x + dx, y + dy);
								// console.log( x, y );
							})

							bind(document, 'mouseup', e.f2 = function(ev) {
								mod.style.transitionDuration = duration;
								mod.style.opacity = 1;

								self._reset(mod);
								self._update && self._update(self.mods);

								unbind(document, 'mousemove', e.f1);
								unbind(document, 'mouseup', e.f2);
							})
						}
					})

					bind(this.box, 'transitionend', function() {
						self._ordering = false;
					})
				},

				_check: function(x, y) {
					if(this._ordering) return;
					var mod, left, top, width, height, newMods, tmp, tmp2, minIndex, maxIndex;
					for(var i = 0, m = this.mods.length; i < m; i++) {
						mod = this.mods[i];
						if(mod !== this.mod) {
							left = mod.offsetLeft;
							top = mod.offsetTop;
							width = mod.offsetWidth;
							height = mod.offsetHeight;

							if(left <= x && top <= y && left + width >= x && top + height >= y) {
								tmp = slice.call(this.mods);


								minIndex = Math.min(mod.index, this.mod.index);
								maxIndex = Math.max(mod.index, this.mod.index) + 1;
								
								tmp2 = tmp.slice(minIndex, maxIndex);

								if(this.mod.index < mod.index) {
									tmp2.push( tmp2.shift() )
								} else {
									tmp2.unshift( tmp2.pop() )
								}
								
								newMods = [].concat( tmp.slice(0, minIndex), tmp2, tmp.slice(maxIndex) )

								this._order(this.mods, newMods);
								return;
							}
							
						}
					}
				},

				_order: function(a, b) {
					if(this._ordering) return;
					this._ordering = true;

					this.mods = b;

					var self = this;
					this.mapPos = a.map(function(e, i) {
						return {x: e.x, y: e.y}
					})
					b.forEach(function(e, i) {
						e.x = self.mapPos[i].x;
						e.y = self.mapPos[i].y;
						e.index = i;
						if(e !== self.mod) {
							e.style.left = e.x + 'px';
							e.style.top = e.y + 'px';
						}
					})
					// this._ordering = false;
				},

				_reset: function(e) {
					e.style.left = e.x + 'px';
					e.style.top = e.y + 'px';
				},

				_getMod(e) {
					do {
						if(e && e.parentNode === this.box)
							return e;
					} while(e = e.parentNode);
					return null;
				},

				onupdate: function(fn) {
					this._update = fn.bind(this);
				}
			}

			window.Designer = Designer;
		})(window);
	</script>

	<script>
		var box = document.getElementById('box');

//		var order = (localStorage.getItem('order') || '1,2,3,4,5,6,7,8,9').split(',') ;
		var order =  '1,2,3,4,5,6,7,8,9'.split(',')
		box.innerHTML = (function() {
			return order.map(e => {
				return `
					<li data-mid="${e}">
						<div class="ctn">
							<div class="head">
								<i>☰</i>
							</div>
							<div class="body">
								${e}
							</div>
						</div>
					</li>
				`
			}).join('')
		})();

		var designer = new Designer( box );

		designer.onupdate(function(mods) {
//			localStorage.setItem('order', mods.map(e => e.mid));
		})
		
	</script>
</body>
</html>